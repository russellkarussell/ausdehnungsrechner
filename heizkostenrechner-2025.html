<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heizkostenersparnis-Rechner</title>
  <!-- Hinzugefügte Bibliotheken für den PDF-Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* Farbvariablen basierend auf dem Design */
    :root {
      --primary-color: #4DBCE9; /* Türkis */
      --accent-color: #F39C12;  /* Orange */
      --text-color-dark: #34495E; /* Dunkelgrau */
      --text-color-light: #555;
      --border-color: #bdc3c7; /* Helleres Grau für Grenzen */
      --background-light: #f4f7f6;
      --background-card: #ffffff;
      --active-background: #e0f7fa; /* Sehr helles Türkis für aktive Hintergründe */
    }

    body {
      font-family: 'Inter', Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      color: var(--text-color-dark);
      background-color: var(--background-light);
    }
    .container {
        max-width: 750px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--background-card);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        overflow: hidden; /* Verhindert, dass Ränder bei Animationen überlappen */
    }
    h1 {
      color: var(--text-color-dark); 
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }
    h2, h3 {
      color: var(--primary-color); 
      font-weight: 500;
    }
    h2 {
      margin-top: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
      margin-bottom: 20px;
    }
    h3 {
        margin-top: 25px;
        margin-bottom: 10px;
        font-size: 1.2rem;
    }
    form {
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      color: var(--text-color-light);
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    input[type="range"] {
        width: 100%;
        margin-top: 8px;
        accent-color: var(--accent-color); 
    }
    .slider-container {
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .slider-container input[type="range"] {
        flex-grow: 1;
        margin-top: 0;
    }
    .slider-container .slider-value {
        font-weight: bold;
        color: var(--accent-color); 
        min-width: 85px;
        text-align: right;
        white-space: nowrap;
        font-size: 0.95em;
    }

    input:focus, input[type="range"]:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25); 
        outline: none;
    }
    
    .calculation-method-selector {
      display: flex;
      gap: 15px;
      justify-content: space-between;
      margin-top: 10px;
      margin-bottom: 25px;
    }
    .method-option-card {
      flex: 1;
      display: block;
      padding: 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
      background-color: var(--background-card);
      min-width: 0;
    }
    .method-option-card input[type="radio"] {
      display: none;
    }
    .method-option-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .method-option-content svg {
      width: 48px;
      height: 48px;
      margin-bottom: 10px;
      fill: var(--text-color-light);
      transition: fill 0.3s;
    }
    .method-option-content span {
      font-weight: bold;
      color: var(--text-color-dark);
      font-size: 0.95rem;
    }
    .method-option-card:hover {
      border-color: var(--accent-color);
      background-color: #fffaf0; 
    }
    label.method-option-card:has(input[type="radio"]:checked) { 
        border-color: var(--primary-color) !important; 
        background-color: var(--active-background) !important;
        box-shadow: 0 0 8px rgba(77, 188, 233, 0.3) !important;
    }
    label.method-option-card:has(input[type="radio"]:checked) .method-option-content svg {
        fill: var(--primary-color);
    }
    label.method-option-card:has(input[type="radio"]:checked) .method-option-content span {
        color: var(--primary-color);
    }

    .input-block {
      margin-top: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #f9fafb; 
    }
    .input-group { 
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .input-group input[type="number"] { 
        flex-grow: 1;
    }
    .input-group span {
        white-space: nowrap;
        color: var(--text-color-light);
    }

    .hidden {
        display: none;
    }
    .sub-options {
        padding-left: 25px;
        border-left: 3px solid #e0e0e0;
        margin-left: 10px;
        margin-top: 10px;
    }
    .derived-value-display {
        text-align: center;
        font-size: 0.9em;
        color: var(--text-color-light);
        margin-top: 8px;
    }
    .derived-value-display span {
        font-weight: bold;
        color: var(--text-color-dark);
    }

    .icon-selection-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: space-around;
        margin-top: 10px;
        margin-bottom: 10px;
    }
    .icon-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s, box-shadow 0.3s;
        text-align: center;
        min-width: 100px;
        background-color: var(--background-card);
        flex-basis: calc(33.333% - 10px);
        box-sizing: border-box;
    }
     .icon-option:hover {
        border-color: var(--accent-color);
        background-color: #fffaf0;
    }
    .icon-option.active {
        border-color: var(--primary-color); 
        background-color: var(--active-background);
        box-shadow: 0 0 8px rgba(77, 188, 233, 0.3);
    }
    .icon-option svg {
        width: 40px;
        height: 40px;
        margin-bottom: 8px;
        fill: var(--text-color-light);
    }
    .icon-option.active svg {
        fill: var(--primary-color);
    }
    .icon-option .option-text {
        font-size: 0.85em;
        color: var(--text-color-dark);
        line-height: 1.2;
    }
     .icon-option .option-text small {
        font-size: 0.9em;
        color: #6c757d;
        display: block;
    }
    .icon-option.active .option-text {
        font-weight: bold;
        color: var(--primary-color);
    }
    
    #results {
      padding: 20px;
      border: 2px solid var(--primary-color); 
      border-radius: 6px;
      background: var(--active-background); 
    }
    #results h2 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: none;
    }
    #results p {
      margin: 10px 0;
      font-size: 1.05rem;
    }
    .derived-scop-info {
        font-size: 0.9em;
        color: var(--text-color-light);
        margin-top: -5px;
        margin-bottom: 5px;
    }
    .highlight {
      font-weight: bold;
      color: var(--accent-color); 
    }
    .highlight.negative {
        color: #e74c3c; /* Rote Farbe für negative Werte */
    }

    .disclaimer {
      margin-top: 10px;
      font-size: 0.85em;
      color: #6c757d;
    }
    .price-update-info { 
        font-size: 0.8em;
        color: #7f8c8d;
        text-align: center;
        margin-top: 25px;
        padding: 10px;
        background-color: #ecf0f1;
        border-radius: 4px;
    }

    .export-button-container {
        text-align: center;
        margin-top: 20px;
    }
    #exportPdfButton {
        background-color: var(--accent-color);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s, box-shadow 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #exportPdfButton:hover {
        background-color: #e68a00; /* Darker orange */
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    #exportPdfButton:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }

    /* === NEUE STYLES FÜR MEHRSTUFIGES FORMULAR === */
    .page {
        display: none;
        animation: fadeIn 0.5s;
    }
    .page.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .navigation-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
    .nav-btn {
        background-color: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .nav-btn:hover {
        background-color: #3ca9d5;
    }
    .nav-btn:disabled {
        background-color: #bdc3c7;
        cursor: not-allowed;
    }
    #prevBtn {
        background-color: #95a5a6;
    }
    #prevBtn:hover:not(:disabled) {
        background-color: #7f8c8d;
    }
    .progress-bar-container {
        width: 100%;
        background-color: #ecf0f1;
        border-radius: 5px;
        margin-bottom: 25px;
    }
    .progress-bar {
        width: 0%;
        height: 10px;
        background-color: var(--primary-color);
        border-radius: 5px;
        transition: width 0.4s ease-in-out;
    }
    
    @media (max-width: 700px) {
        .icon-selection-group { justify-content: center; }
        .icon-option { min-width: 90px; flex-basis: calc(48% - 10px); }
        .icon-option svg { width: 36px; height: 36px; }
         .calculation-method-selector {
            flex-direction: column;
        }
    }
    @media (max-width: 600px) {
        body { margin: 10px; }
        .container { padding: 15px; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.5rem; }
        .input-group, .slider-container { flex-direction: column; align-items: stretch; }
        .input-group span, .slider-container .slider-value { margin-top: 5px; text-align: left; min-width: auto; }
        .icon-option { min-width: 80px; flex-basis: calc(50% - 5px);}
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>Heizkostenersparnis-Rechner</h1>
    
    <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
    </div>

    <form id="calculatorForm">
      <input type="hidden" id="gebaeudeklasseValue" name="gebaeudeklasseValue" value="alt_unsaniert">
      <input type="hidden" id="heizsystemValue" name="heizsystemValue" value="heizoel">
      <input type="hidden" id="solarthermieTypeValue" name="solarthermieTypeValue" value="flach">

      <!-- Seite 1: Daten zur Altanlage -->
      <div id="page1" class="page">
          <h2>Schritt 1: Daten zur Altanlage</h2>
          <h3>Berechnungsgrundlage</h3>
          <p>Bitte wählen Sie, ob die Berechnung auf Basis Ihrer beheizbaren Fläche oder Ihres bisherigen Verbrauchs erfolgen soll.</p>
          <div class="calculation-method-selector">
            <label class="method-option-card">
                <input type="radio" name="method" value="flaeche" checked>
                <div class="method-option-content">
                    <svg viewBox="0 0 64 64" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M54 20L32 6 10 20v30h44V20zM24 44h-4v-8h4v8zm8 0h-4v-8h4v8zm8 0h-4v-8h4v8zm0-12h-4v-8h4v8zm-8 0h-4v-8h4v8zm-8-8h4v-4H20l4 4zM44 24h-4v-4h4v4z"/></svg>
                    <span>Flächenbasierte Berechnung</span>
                </div>
            </label>
            <label class="method-option-card">
                <input type="radio" name="method" value="verbrauch">
                <div class="method-option-content">
                    <svg viewBox="0 0 64 64" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M32 4C19.85 4 10 13.85 10 26c0 7.33 3.58 13.73 9 17.54V52c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8.46c5.42-3.81 9-10.21 9-17.54C54 13.85 44.15 4 32 4zm0 32c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm8-12.82C38.39 22.51 35.42 22 32 22s-6.39.51-8 1.18V20h16v3.18z"/></svg>
                    <span>Verbrauchsbasierte Berechnung</span>
                </div>
            </label>
          </div>
          <div id="blockVerbrauch" class="hidden">
              <div class="input-block">
                  <h3>Ihr Verbrauch</h3>
                  <label for="verbrauch">Jährlicher Verbrauch</label>
                  <div class="input-group">
                      <input type="number" id="verbrauch" min="0" step="0.1" value="2000" placeholder="z. B. 2000" />
                      <span id="einheitVerbrauch">Liter</span>
                  </div>
              </div>
          </div>
          <div id="blockFlaeche">
              <div class="input-block">
                  <h3>Ihre Immobilie</h3>
                  <label>Gebäudeklasse</label>
                  <div id="gebaeudeklasseIconGroup" class="icon-selection-group"></div>
                  <label for="flaecheSlider">Beheizbare Fläche (m²)</label>
                  <div class="slider-container">
                      <input type="range" id="flaecheSlider" min="50" max="400" step="1" value="150" />
                      <span id="flaecheValue" class="slider-value">150 m²</span>
                  </div>
              </div>
          </div>
          <div class="input-block">
              <h3>Ihr aktuelles Heizsystem</h3>
              <div id="heizsystemIconGroup" class="icon-selection-group"></div>
              <label for="wirkungsgradAltSlider">Wirkungsgrad Altanlage (%)</label>
              <div class="slider-container">
                  <input type="range" id="wirkungsgradAltSlider" min="50" max="100" step="1" value="80" />
                  <span id="wirkungsgradAltValue" class="slider-value">80 %</span>
              </div>
              <div class="disclaimer">Typischer Wert wird je nach Heizsystem vorausgewählt.</div>
              <label for="preisSlider">Aktueller Preis je Einheit</label>
              <div class="slider-container">
                  <input type="range" id="preisSlider" min="0.50" max="2.50" step="0.01" value="1.03" />
                  <span id="preisValue" class="slider-value">1.03 €/Liter</span>
              </div>
          </div>
      </div>
      
      <!-- Seite 2: Neues System & Optimierung -->
      <div id="page2" class="page">
        <h2>Schritt 2: Neues System & Optimierung</h2>
        <div class="input-block">
            <h3>Daten für Wärmepumpe</h3>
            <label for="strompreisSlider">Netz-Strompreis für Wärmepumpe (€/kWh)</label>
            <div class="slider-container">
                <input type="range" id="strompreisSlider" min="0.15" max="0.60" step="0.01" value="0.19" />
                <span id="strompreisValue" class="slider-value">0.19 €/kWh</span>
            </div>
            <div class="disclaimer">Dieser Preis gilt auch für "Altanlage Strom".</div>
            <label for="anteilFussbodenheizungSlider">Anteil Fußbodenheizung an Wärmeabgabe (%)</label>
            <div class="slider-container">
                <input type="range" id="anteilFussbodenheizungSlider" min="0" max="100" step="1" value="50" />
                <span id="anteilFussbodenheizungValue" class="slider-value">50 %</span>
            </div>
            <div class="disclaimer">Wird automatisch basierend auf Gebäudeklasse angepasst.</div>
            <label for="vorlauftemperaturSlider">Vorlauftemperatur (°C)</label>
            <div class="slider-container">
                <input type="range" id="vorlauftemperaturSlider" min="30" max="75" step="1" value="55" />
                <span id="vorlauftemperaturValue" class="slider-value">55 °C</span>
            </div>
            <p class="derived-scop-info">Abgeleiteter Basis-SCOP: <span id="basisSCOPValue" style="font-weight:bold; color: var(--accent-color);">3.0</span></p>
        </div>
        <div class="input-block">
          <h3>Zusätzliche Optimierungen</h3>
          <p>Wählen Sie optionale Komponenten aus, um die Berechnung zu verfeinern.</p>
          <div id="optimizationSelectionGroup" class="icon-selection-group"></div>
          <div id="pvOptions" class="sub-options hidden">
              <label for="pvAnteilSlider">Anteil des WP-Stroms durch PV gedeckt (%)</label>
              <div class="slider-container">
                  <input type="range" id="pvAnteilSlider" min="0" max="100" step="1" value="30" />
                  <span id="pvAnteilValue" class="slider-value">30 %</span>
              </div>
              <label for="pvStrompreisInput">Kosten für PV-Strom (€/kWh)</label>
              <div class="input-group">
                  <input type="number" id="pvStrompreisInput" min="0" max="0.5" step="0.01" value="0.08" />
                  <span>€/kWh</span>
              </div>
              <div class="disclaimer">Geben Sie hier Ihre Gestehungskosten an.</div>
          </div>
          <div id="solarthermieOptions" class="sub-options hidden">
              <label>Kollektortyp</label>
              <div id="solarthermieTypeIconGroup" class="icon-selection-group" style="justify-content: center; gap: 20px;"></div>
              <label for="solarthermieFlaecheSlider">Kollektorfläche der Solaranlage (m²)</label>
              <div class="slider-container">
                  <input type="range" id="solarthermieFlaecheSlider" min="0" max="30" step="1" value="4" />
                  <span id="solarthermieFlaecheValue" class="slider-value">4 m²</span>
              </div>
              <div id="solarthermieErtragDisplay" class="derived-value-display">
                  Geschätzter Jahresertrag: <span id="solarthermieErtragValue">0</span> kWh
              </div>
              <div class="disclaimer">Der Ertrag reduziert den Wärmebedarf, den die Heizung decken muss.</div>
          </div>
        </div>
      </div>

      <!-- Seite 3: Investition & Kosten -->
      <div id="page3" class="page">
        <h2>Schritt 3: Investition & Kosten</h2>
        <div class="input-block">
            <h3>Investitionskosten & Förderung Wärmepumpe</h3>
            <label for="investitionSlider">Investitionskosten Wärmepumpe (inkl. Einbau) in €</label>
            <div class="slider-container">
                <input type="range" id="investitionSlider" min="5000" max="50000" step="500" value="20000" />
                <span id="investitionValue" class="slider-value">20000 €</span>
            </div>
            <div class="disclaimer">Durchschnitt: 15.000–30.000 €. Addieren Sie Kosten für Zusatz-Optimierungen.</div>

            <label for="foerderungenSlider">Erwartete Förderungen (einmalig) in €</label>
            <div class="slider-container">
                <input type="range" id="foerderungenSlider" min="0" max="25000" step="100" value="5000" />
                <span id="foerderungenValue" class="slider-value">5000 €</span>
            </div>
            <div class="disclaimer">Reduziert die effektiven Investitionskosten.</div>
        </div>
        <div class="input-block">
            <h3>Laufende Kosten</h3>
            <label for="wartungskostenAltSlider">Jährliche Wartungskosten Altanlage (€)</label>
            <div class="slider-container">
                <input type="range" id="wartungskostenAltSlider" min="0" max="1000" step="10" value="150" />
                <span id="wartungskostenAltValue" class="slider-value">150 €</span>
            </div>
            <label for="wartungskostenWPSlider">Jährliche Wartungskosten Wärmepumpe (€)</label>
            <div class="slider-container">
                <input type="range" id="wartungskostenWPSlider" min="0" max="1000" step="10" value="250" />
                <span id="wartungskostenWPValue" class="slider-value">250 €</span>
            </div>
        </div>
      </div>

      <!-- Seite 4: Ergebnis -->
      <div id="page4" class="page">
        <h2>Schritt 4: Ihr Ergebnis</h2>
        <div id="results">
            <p>Nutzwärmebedarf (Altanlage): <span class="highlight" id="nutzwaermeBedarf">0</span> kWh / Jahr</p>
            <p>Aktuelle Heizkosten (Altanlage): <span class="highlight" id="kostenAktuell">0</span> € / Jahr</p>
            <p>CO₂-Emissionen (Altanlage): <span class="highlight" id="co2Altanlage">0</span> kg / Jahr</p>
            <hr style="border-color: var(--primary-color); opacity: 0.5;">
            <p>Ungefähre Heizleistung Wärmepumpe: <span class="highlight" id="wpLeistung">0</span> kW</p>
            <p>Angepasste JAZ/SCOP für WP: <span class="highlight" id="jazEffektiv">0</span></p>
            <p>Heizkosten mit Wärmepumpe: <span class="highlight" id="kostenWP">0</span> € / Jahr</p>
            <p>CO₂-Emissionen (Wärmepumpe): <span class="highlight" id="co2WP">0</span> kg / Jahr</p>
            <hr style="border-color: var(--primary-color); opacity: 0.5;">
            <p>Jährliche Ersparnis (Betriebskosten): <span class="highlight" id="ersparnis">0</span> €</p>
            <p>Jährliche CO₂-Einsparung: <span class="highlight" id="co2Ersparnis">0</span> kg<br>
                <small style="font-size:0.9em; color: var(--text-color-light);">entspricht ca. <span class="highlight" id="co2Fussballfelder">0</span> Fußballfeldern Waldfläche pro Jahr.</small>
            </p>
            <p>Amortisationszeit (nach Förderung): <span class="highlight" id="amortisation">–</span> Jahre</p>
            <div class="disclaimer">* Alle Werte sind ungefähre Richtwerte. Die empfohlene Heizleistung ist eine grobe Schätzung; eine detaillierte Heizlastberechnung durch einen Fachbetrieb ist für die korrekte Dimensionierung unerlässlich.</div>
        </div>
        <div id="exportContainer" class="export-button-container">
            <button id="exportPdfButton">PDF Exportieren</button>
        </div>
        <div class="price-update-info">
            Die Standard-Energiepreise im Rechner sind Richtwerte (Stand: Juni 2025) und sollten für eine genaue Berechnung mit Ihren aktuellen Tarifen abgeglichen werden.
        </div>
      </div>
      
      <div class="navigation-buttons">
        <button type="button" id="prevBtn" class="nav-btn">Zurück</button>
        <button type="button" id="nextBtn" class="nav-btn">Weiter</button>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('calculatorForm');
      
      const config = {
          energyFactors: { heizoel: 9.9, erdgas_h: 10.6, erdgas_l: 9.2, fluessiggas: 6.7, pellets: 4.9, strom: 1.0 },
          defaultPrices: { 
              heizoel: 1.03, erdgas_h: (0.11 * 10.6).toFixed(3), erdgas_l: (0.11 * 9.2).toFixed(3),
              fluessiggas: 0.70, pellets: 0.30, strom: 0.19
          },
          priceSliderConfigs: {
              heizoel:     { min: 0.50, max: 2.50, step: 0.01, unit: "€/Liter" },
              erdgas_h:    { min: 0.50, max: 3.00, step: 0.01, unit: "€/m³" }, 
              erdgas_l:    { min: 0.50, max: 3.00, step: 0.01, unit: "€/m³" },
              fluessiggas: { min: 0.40, max: 2.00, step: 0.01, unit: "€/Liter" },
              pellets:     { min: 0.15, max: 0.80, step: 0.01, unit: "€/kg" },
              strom:       { min: 0.15, max: 0.60, step: 0.01, unit: "€/kWh" } 
          },
          defaultWirkungsgrade: { 
              heizoel: 80, erdgas_h: 82, erdgas_l: 82, fluessiggas: 85, pellets: 88, strom: 100
          },
          co2FactorsKwhInput: { 
              heizoel: 0.269, erdgas_h: 0.202, erdgas_l: 0.202, fluessiggas: 0.230,
              pellets: 0.02, strom: 0.12 
          },
          stromCo2Faktor: 0.12,
          kgCo2ProFussballfeldWaldProJahr: 5600,
          klasseFactors: { alt_unsaniert: 200, alt_teilsaniert: 150, alt_saniert: 100, neubau: 70, niedrigenergie: 30 },
          heizkoerperventilatorEffekt: 8,
          solarYieldFactors: { flach: 350, roehren: 450 } 
      };

      const dom = {
        pages: document.querySelectorAll('.page'),
        prevBtn: document.getElementById('prevBtn'),
        nextBtn: document.getElementById('nextBtn'),
        progressBar: document.getElementById('progressBar'),
        navigationButtons: document.querySelector('.navigation-buttons'),
        radios: form.elements['method'],
        blockVerbrauch: document.getElementById('blockVerbrauch'),
        blockFlaeche: document.getElementById('blockFlaeche'),
        gebaeudeklasseValueInput: document.getElementById('gebaeudeklasseValue'),
        heizsystemValueInput: document.getElementById('heizsystemValue'),
        solarthermieTypeValue: document.getElementById('solarthermieTypeValue'),
        wirkungsgradAltSlider: document.getElementById('wirkungsgradAltSlider'),
        wirkungsgradAltValue: document.getElementById('wirkungsgradAltValue'),
        verbrauch: document.getElementById('verbrauch'),
        einheitVerbrauch: document.getElementById('einheitVerbrauch'),
        preisSlider: document.getElementById('preisSlider'),
        preisValue: document.getElementById('preisValue'),
        heizsystemIconGroup: document.getElementById('heizsystemIconGroup'),
        gebaeudeklasseIconGroup: document.getElementById('gebaeudeklasseIconGroup'),
        flaecheSlider: document.getElementById('flaecheSlider'),
        flaecheValue: document.getElementById('flaecheValue'),
        anteilFussbodenheizungSlider: document.getElementById('anteilFussbodenheizungSlider'),
        anteilFussbodenheizungValue: document.getElementById('anteilFussbodenheizungValue'),
        strompreisSlider: document.getElementById('strompreisSlider'),
        strompreisValue: document.getElementById('strompreisValue'),
        vorlauftemperaturSlider: document.getElementById('vorlauftemperaturSlider'),
        vorlauftemperaturValue: document.getElementById('vorlauftemperaturValue'),
        basisSCOPValueElem: document.getElementById('basisSCOPValue'),
        investitionSlider: document.getElementById('investitionSlider'),
        investitionValue: document.getElementById('investitionValue'),
        foerderungenSlider: document.getElementById('foerderungenSlider'),
        foerderungenValue: document.getElementById('foerderungenValue'),
        optimizationSelectionGroup: document.getElementById('optimizationSelectionGroup'),
        wartungskostenAltSlider: document.getElementById('wartungskostenAltSlider'),
        wartungskostenAltValue: document.getElementById('wartungskostenAltValue'),
        wartungskostenWPSlider: document.getElementById('wartungskostenWPSlider'),
        wartungskostenWPValue: document.getElementById('wartungskostenWPValue'),
        pvOptions: document.getElementById('pvOptions'),
        pvAnteilSlider: document.getElementById('pvAnteilSlider'),
        pvAnteilValue: document.getElementById('pvAnteilValue'),
        pvStrompreisInput: document.getElementById('pvStrompreisInput'),
        solarthermieOptions: document.getElementById('solarthermieOptions'),
        solarthermieTypeIconGroup: document.getElementById('solarthermieTypeIconGroup'),
        solarthermieFlaecheSlider: document.getElementById('solarthermieFlaecheSlider'),
        solarthermieFlaecheValue: document.getElementById('solarthermieFlaecheValue'),
        solarthermieErtragValue: document.getElementById('solarthermieErtragValue'),
        resultsDiv: document.getElementById('results'),
        exportContainer: document.getElementById('exportContainer'),
        exportPdfButton: document.getElementById('exportPdfButton'),
        nutzwaermeBedarfElem: document.getElementById('nutzwaermeBedarf'),
        kostenAktuellElem: document.getElementById('kostenAktuell'),
        co2AltanlageElem: document.getElementById('co2Altanlage'),
        wpLeistungElem: document.getElementById('wpLeistung'),
        jazEffektivElem: document.getElementById('jazEffektiv'),
        kostenWPElem: document.getElementById('kostenWP'),
        co2WPElem: document.getElementById('co2WP'),
        ersparnisElem: document.getElementById('ersparnis'),
        co2ErsparnisElem: document.getElementById('co2Ersparnis'),
        co2FussballfelderElem: document.getElementById('co2Fussballfelder'),
        amortisationElem: document.getElementById('amortisation'),
      };
      
      const gebaeudeklasseDefinitions = [
        { value: "alt_unsaniert", text: "Altbau, unsaniert", kWhText: "(~200 kWh/m²·a)", svg: `<svg viewBox="0 0 64 64"><path d="M32 4L4 22v30h12V32h8v20h24V22L32 4zm-4 36h-8v-8h8v8zm16 0h-8v-8h8v8z" stroke="#555" stroke-width="1.5" opacity="0.7" fill="#d3a17d"/><path d="M10 20 L10 15 L15 15 M54 20 L54 15 L49 15 M20 10 L15 15 M44 10 L49 15" stroke="#8b4513" stroke-width="2.5" fill="none" opacity="0.6"/><rect x="26" y="42" width="12" height="10" fill="#a0522d" opacity="0.8"/></svg>` },
        { value: "alt_teilsaniert", text: "Altbau, teilsaniert", kWhText: "(~150 kWh/m²·a)", svg: `<svg viewBox="0 0 64 64"><path d="M32 4L4 22v30h56V22L32 4zM16 50H8V30h8v20zm32 0h-8V30h8v20zM28 34h8v16h-8V34z" stroke="#555" stroke-width="1.5" fill="#e0c9a6"/><rect x="20" y="24" width="24" height="8" fill="#66bb6a" opacity="0.8"/><path d="M32 6 L10 20 M32 6 L54 20" stroke="#a0522d" stroke-width="2.5" fill="none"/></svg>` },
        { value: "alt_saniert", text: "Altbau, saniert", kWhText: "(~100 kWh/m²·a)", svg: `<svg viewBox="0 0 64 64"><path d="M32 2L2 20v34h60V20L32 2zm0 4.5L54.8 20H9.2L32 6.5zM58 50H6V22h52v28z" fill="#f5f5f5" stroke="#555" stroke-width="1.5"/><rect x="16" y="28" width="8" height="12" fill="#b3e5fc" stroke="#333" stroke-width="1.2"/><rect x="40" y="28" width="8" height="12" fill="#b3e5fc" stroke="#333" stroke-width="1.2"/><rect x="28" y="40" width="8" height="10" fill="#ffcc80" stroke="#333" stroke-width="1.2"/></svg>` },
        { value: "neubau", text: "Neubau", kWhText: "(~70 kWh/m²·a)", svg: `<svg viewBox="0 0 64 64"><rect x="6" y="18" width="52" height="36" fill="#e3f2fd" stroke="#555" stroke-width="1.5"/><polygon points="4,18 32,6 60,18" fill="#cfd8dc" stroke="#555" stroke-width="1.5"/><rect x="16" y="30" width="10" height="18" fill="#ffffff" stroke="#444" stroke-width="1.2"/><rect x="38" y="30" width="10" height="10" fill="#ffffff" stroke="#444" stroke-width="1.2"/><line x1="6" y1="28" x2="58" y2="28" stroke="#90a4ae" stroke-width="2.5"/></svg>` },
        { value: "niedrigenergie", text: "Niedrigenergiehaus", kWhText: "(~30 kWh/m²·a)", svg: `<svg viewBox="0 0 64 64"><path d="M32 4L4 20v30h56V20L32 4z" fill="#dcedc8" stroke="#4caf50" stroke-width="1.5"/><rect x="24" y="32" width="16" height="16" fill="#c8e6c9" stroke="#4caf50" stroke-width="1.2"/><path d="M32 12 A12 12 0 0 1 44 24 A12 12 0 0 1 32 36 A12 12 0 0 1 20 24 A12 12 0 0 1 32 12 M32 16 A4 4 0 0 0 28 20 L36 28 A4 4 0 0 0 32 16" fill="#ffee58" opacity="0.9"/><path d="M28 40 L36 40 L32 48 Z" fill="#66bb6a"/></svg>`}
      ];
      const heizsystemDefinitions = [
        { value: "heizoel", text: "Heizöl (EL)", svg: `<svg viewBox="0 0 64 64"><path d="M32 6C20.9 6 12 14.9 12 26c0 7.8 4.9 14.5 11.9 17.3l-.6 9.3h17.4l-.6-9.3C47.1 40.5 52 33.8 52 26c0-11.1-8.9-20-20-20zm0 32c-6.6 0-12-5.4-12-12s5.4-12 12-12 12 5.4 12 12-5.4 12-12 12z" fill="#795548"/><circle cx="32" cy="26" r="8" fill="#a1887f"/></svg>` },
        { value: "erdgas_h", text: "Erdgas (H-Gas)", svg: `<svg viewBox="0 0 64 64"><path d="M32 2C19.7 2 9.8 10.1 7 21.3c4.6-3.2 10.1-5.3 16-5.3 11.8 0 21.4 8.6 23.7 19.9C51.2 42.8 56 37.2 56 30.6c0-10.3-8.9-18.7-20-19.9V2c-1.3 0-2.6.1-4 .3zm11.1 34.8C40.6 46.2 32.9 52 24 52c-4.4 0-8.5-1.3-12-3.5 3.2 6.7 10 11.5 17.9 11.5 10.5 0 19.1-7.7 20.1-17.9z" fill="#ff9800"/><path d="M27.4 30.1c-2.4-1.2-5.2-1.8-8-1.8-6.5 0-12.3 2.7-16.4 7C7.1 21.9 18.4 12 32 12c.7 0 1.3.1 2 .1-3.6 5.5-5.5 12.1-4.6 18z" fill="#f57c00"/></svg>` },
        { value: "erdgas_l", text: "Erdgas (L-Gas)", svg: `<svg viewBox="0 0 64 64"><path d="M32 2C19.7 2 9.8 10.1 7 21.3c4.6-3.2 10.1-5.3 16-5.3 11.8 0 21.4 8.6 23.7 19.9C51.2 42.8 56 37.2 56 30.6c0-10.3-8.9-18.7-20-19.9V2c-1.3 0-2.6.1-4 .3zm11.1 34.8C40.6 46.2 32.9 52 24 52c-4.4 0-8.5-1.3-12-3.5 3.2 6.7 10 11.5 17.9 11.5 10.5 0 19.1-7.7 20.1-17.9z" fill="#ffb74d"/><path d="M27.4 30.1c-2.4-1.2-5.2-1.8-8-1.8-6.5 0-12.3 2.7-16.4 7C7.1 21.9 18.4 12 32 12c.7 0 1.3.1 2 .1-3.6 5.5-5.5 12.1-4.6 18z" fill="#ffa726"/></svg>` },
        { value: "fluessiggas", text: "Flüssiggas", svg: `<svg viewBox="0 0 64 64"><rect x="18" y="10" width="28" height="44" rx="8" fill="#bdbdbd" stroke="#757575" stroke-width="1.5"/><rect x="22" y="12" width="20" height="8" fill="#9e9e9e"/><line x1="32" y1="20" x2="32" y2="28" stroke="#757575" stroke-width="2.5"/><path d="M26 32h12l-2 6h-8z" fill="#f44336" /></svg>` },
        { value: "pellets", text: "Holzpellets", svg: `<svg viewBox="0 0 64 64"><path d="M12 52h40v4H12zM16 48l4-10h24l4 10zM20 34l4-10h16l4 10zM24 20l4-10h8l4 10z" fill="#c8b7a1" stroke="#8d6e63" stroke-width="1"/><circle cx="22" cy="42" r="3" fill="#a1887f"/><circle cx="32" cy="46" r="3" fill="#a1887f"/><circle cx="42" cy="42" r="3" fill="#a1887f"/><circle cx="28" cy="30" r="3" fill="#a1887f"/><circle cx="36" cy="30" r="3" fill="#a1887f"/><circle cx="32" cy="18" r="3" fill="#a1887f"/></svg>` },
        { value: "strom", text: "Strom", svg: `<svg viewBox="0 0 64 64"><path d="M32 2L12 32h12l-4 20 24-30H32l4-20z" fill="#ffea00" stroke="#fbc02d" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/></svg>` }
      ];
      const optimizationDefinitions = [
        { id: 'pv', text: 'Photovoltaik', subOptionsId: 'pvOptions', svg: `<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="10" fill="#FFEB3B"/><path fill="none" stroke="#FFC107" stroke-width="3" stroke-linecap="round" d="M32 5v6M32 53v6M59 32h-6M11 32H5m40-22l-4 4M13 47l-4 4m0-34l4 4m32 26l4 4"/><path d="M25 44l6 14 6-14h-5l3-8h-7l3 8z" fill="#444"/></svg>` },
        { id: 'solarthermie', text: 'Solarthermie', subOptionsId: 'solarthermieOptions', svg: `<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="10" fill="#FFEB3B"/><path fill="none" stroke="#FFC107" stroke-width="3" stroke-linecap="round" d="M32 5v6M32 53v6M59 32h-6M11 32H5m40-22l-4 4M13 47l-4 4m0-34l4 4m32 26l4 4"/><path d="M22 54s-2-8 10-8 10 8 10 8z" fill="#4FC3F7" opacity="0.8"/><path d="M26 48s-2-8 6-8 6 8 6 8z" fill="#29B6F6" opacity="0.8"/></svg>` },
        { id: 'fans', text: 'Heizkörperlüfter', subOptionsId: null, svg: `<svg viewBox="0 0 64 64"><rect x="10" y="16" width="44" height="28" rx="2" fill="#CFD8DC"/><path d="M12 18h4v24h-4z m6 0h4v24h-4z m6 0h4v24h-4z m6 0h4v24h-4z m6 0h4v24h-4z m6 0h4v24h-4z" fill="#ECEFF1"/><circle cx="32" cy="46" r="6" fill="#90A4AE"/><path d="M32 40v12m-6-6h12m-8.5-2.5l5 5m-5-5l-5 5" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg>` }
      ];
      const solarthermieTypeDefinitions = [
        { value: "flach", text: "Flachkollektor", svg: `<svg viewBox="0 0 64 64"><rect x="10" y="12" width="44" height="40" fill="#37474F"/><rect x="13" y="15" width="38" height="34" fill="#546E7A"/><path d="M17,20 l30,0 M17,26 l30,0 M17,32 l30,0 M17,38 l30,0 M17,44 l30,0" stroke="#78909C" stroke-width="1.5"/></svg>`},
        { value: "roehren", text: "Röhrenkollektor", svg: `<svg viewBox="0 0 64 64"><rect x="10" y="12" width="44" height="40" fill="#37474F"/><g stroke="#B0BEC5" stroke-width="2.5" fill="#78909C"><rect x="15" y="16" width="6" height="32" rx="3"/><rect x="25" y="16" width="6" height="32" rx="3"/><rect x="35" y="16" width="6" height="32" rx="3"/><rect x="45" y="16" width="6" height="32" rx="3"/></g></svg>`}
      ];


      // --- Seiten-Navigation ---
      let currentPage = 1;
      const totalPages = dom.pages.length;

      function showPage(pageNumber) {
        dom.pages.forEach((page, index) => {
            page.classList.toggle('active', (index + 1) === pageNumber);
        });
        dom.prevBtn.disabled = pageNumber === 1;
        dom.nextBtn.style.display = (pageNumber === totalPages) ? 'none' : 'inline-block';
        if (pageNumber === totalPages) {
            calculateAll();
            dom.navigationButtons.style.justifyContent = 'flex-start';
        } else {
             dom.navigationButtons.style.justifyContent = 'space-between';
        }
        updateProgressBar();
      }

      function updateProgressBar() {
          const progress = ((currentPage - 1) / (totalPages - 1)) * 100;
          dom.progressBar.style.width = `${progress}%`;
      }

      dom.nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
            currentPage++;
            showPage(currentPage);
        }
      });

      dom.prevBtn.addEventListener('click', () => {
        if(currentPage > 1) {
            currentPage--;
            showPage(currentPage);
        }
      });


      // --- UI-Handler und Initialisierung ---

      function setupSlider(sliderElement, valueElement, unit = "", decimals = 0) {
        if (!sliderElement || !valueElement) return;
        const updateDisplay = () => {
            const displayValue = parseFloat(sliderElement.value).toFixed(decimals);
            valueElement.textContent = `${displayValue} ${unit}`;
        };
        sliderElement.addEventListener('input', () => {
            updateDisplay();
            updateUIOnInputChange();
        });
        updateDisplay();
      }
      
      function createIconOptions(definitions, groupElement, hiddenInputElement, callbackOnSelect) {
        groupElement.innerHTML = '';
        definitions.forEach(def => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'icon-option';
            optionDiv.dataset.value = def.value;
            optionDiv.innerHTML = `${def.svg}<span class="option-text">${def.text}${def.kWhText ? `<small>${def.kWhText}</small>` : ''}</span>`;
            if (def.value === hiddenInputElement.value) {
                optionDiv.classList.add('active');
            }
            optionDiv.addEventListener('click', function() {
                groupElement.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                hiddenInputElement.value = this.dataset.value;
                if (callbackOnSelect) callbackOnSelect(this.dataset.value);
            });
            groupElement.appendChild(optionDiv);
        });
      }

      function createOptimizationIcons(definitions, groupElement) {
        groupElement.innerHTML = '';
        definitions.forEach(def => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'icon-option';
            optionDiv.dataset.id = def.id;
            optionDiv.innerHTML = `${def.svg}<span class="option-text">${def.text}</span>`;
            optionDiv.addEventListener('click', function() {
                this.classList.toggle('active');
                updateUIOnInputChange();
            });
            groupElement.appendChild(optionDiv);
        });
      }

      function toggleCalculationMethod() {
        const isVerbrauch = dom.radios.value === 'verbrauch';
        dom.blockVerbrauch.classList.toggle('hidden', !isVerbrauch);
        dom.blockFlaeche.classList.toggle('hidden', isVerbrauch);
        handleHeizsystemChange();
      }

      function handleGebaeudeklasseChange(selectedValue) {
          let fbhAnteil = 50, defaultVorlauf = 55;
          switch(selectedValue) {
              case "alt_unsaniert":   fbhAnteil = 0;   defaultVorlauf = 60; break;
              case "alt_teilsaniert": fbhAnteil = 10;  defaultVorlauf = 55; break;
              case "alt_saniert":     fbhAnteil = 30;  defaultVorlauf = 48; break;
              case "neubau":          fbhAnteil = 90;  defaultVorlauf = 40; break;
              case "niedrigenergie":  fbhAnteil = 100; defaultVorlauf = 35; break;
          }
          dom.anteilFussbodenheizungSlider.value = fbhAnteil;
          dom.vorlauftemperaturSlider.value = defaultVorlauf;
          // Trigger input event to update display and logic
          dom.anteilFussbodenheizungSlider.dispatchEvent(new Event('input'));
          dom.vorlauftemperaturSlider.dispatchEvent(new Event('input'));
      }
      
      function handleHeizsystemChange() {
        const heizsystemGroup = dom.heizsystemIconGroup;
        const wirkungsgradSlider = dom.wirkungsgradAltSlider;
        const preisSlider = dom.preisSlider;
        
        let selectedValue = 'heizoel'; // default
        const activeOption = heizsystemGroup.querySelector('.icon-option.active');
        if (activeOption) {
            selectedValue = activeOption.dataset.value;
        }
        dom.heizsystemValueInput.value = selectedValue;

        if (wirkungsgradSlider) {
            wirkungsgradSlider.value = config.defaultWirkungsgrade[selectedValue] || 85;
            wirkungsgradSlider.dispatchEvent(new Event('input'));
        }
        
        const { verbrauch } = getEinheitText(selectedValue);
        const einheitSpan = dom.einheitVerbrauch;
        if (einheitSpan) einheitSpan.textContent = verbrauch;
        
        const preisValueSpan = dom.preisValue;
        const isStrom = selectedValue === 'strom';
        preisSlider.disabled = isStrom;
        const sliderConfig = isStrom ? config.priceSliderConfigs.strom : config.priceSliderConfigs[selectedValue];
        if (sliderConfig) {
            preisSlider.min = sliderConfig.min;
            preisSlider.max = sliderConfig.max;
            preisSlider.step = sliderConfig.step;
            preisSlider.value = isStrom ? dom.strompreisSlider.value : (config.defaultPrices[selectedValue] || sliderConfig.min);
            const decimals = sliderConfig.step.toString().split('.')[1]?.length || 2;
            preisValueSpan.textContent = `${parseFloat(preisSlider.value).toFixed(decimals)} ${sliderConfig.unit}`;
        }
      }
      
      function getEinheitText(sysKey) {
        const sliderConfig = config.priceSliderConfigs[sysKey] || { unit: "€/Einheit" };
        let verbrauchTxt = 'Einheit';
        switch (sysKey) {
            case 'heizoel': case 'fluessiggas': verbrauchTxt = 'Liter'; break;
            case 'erdgas_h': case 'erdgas_l': verbrauchTxt = 'm³'; break;
            case 'pellets': verbrauchTxt = 'kg'; break;
            case 'strom': verbrauchTxt = 'kWh'; break;
        }
        return { verbrauch: verbrauchTxt, preisUnit: sliderConfig.unit };
      }

      function updateUIOnInputChange() {
        const fanIcon = document.querySelector('.icon-option[data-id="fans"]');
        const pvIcon = document.querySelector('.icon-option[data-id="pv"]');
        const solarIcon = document.querySelector('.icon-option[data-id="solarthermie"]');

        dom.pvOptions.classList.toggle('hidden', !pvIcon?.classList.contains('active'));
        dom.solarthermieOptions.classList.toggle('hidden', !solarIcon?.classList.contains('active'));
        
        const fbhAnteil = parseFloat(dom.anteilFussbodenheizungSlider.value);
        if (fanIcon) {
            const showFanOption = fbhAnteil < 50;
            fanIcon.style.display = showFanOption ? 'flex' : 'none';
            if (!showFanOption) {
                fanIcon.classList.remove('active');
            }
        }
        
        const solarFlaeche = parseFloat(dom.solarthermieFlaecheSlider.value);
        const solarTyp = dom.solarthermieTypeValue.value;
        const solarErtrag = solarFlaeche * (config.solarYieldFactors[solarTyp] || 0);
        dom.solarthermieErtragValue.textContent = solarErtrag.toFixed(0);

        // Update SCOP display dynamically
        const vorlaufTemp = parseFloat(dom.vorlauftemperaturSlider.value);
        const useFans = fanIcon?.classList.contains('active');
        let effektiveVorlaufTemp = vorlaufTemp;
        if (useFans) {
            effektiveVorlaufTemp -= config.heizkoerperventilatorEffekt;
        }
        const basisSCOP = Math.max(2.0, 5 - 0.1 * (effektiveVorlaufTemp - 35));
        dom.basisSCOPValueElem.textContent = basisSCOP.toFixed(1);
      }

      function calculateAll() {
        const fanIcon = document.querySelector('.icon-option[data-id="fans"]');
        const pvIcon = document.querySelector('.icon-option[data-id="pv"]');
        const solarIcon = document.querySelector('.icon-option[data-id="solarthermie"]');
        
        const inputs = {
            method: dom.radios.value,
            isVerbrauch: dom.radios.value === 'verbrauch',
            wirkungsgradAlt: parseFloat(dom.wirkungsgradAltSlider.value) / 100,
            verbrauch: parseFloat(dom.verbrauch.value) || 0,
            aktuellesSystem: dom.heizsystemValueInput.value,
            aktuellerPreis: parseFloat(dom.preisSlider.value),
            gebaeudeklasse: dom.gebaeudeklasseValueInput.value,
            flaeche: parseFloat(dom.flaecheSlider.value),
            anteilFBH: parseFloat(dom.anteilFussbodenheizungSlider.value),
            vorlaufTemp: parseFloat(dom.vorlauftemperaturSlider.value),
            netzStrompreis: parseFloat(dom.strompreisSlider.value),
            investition: parseFloat(dom.investitionSlider.value),
            foerderung: parseFloat(dom.foerderungenSlider.value),
            wartungAlt: parseFloat(dom.wartungskostenAltSlider.value),
            wartungWP: parseFloat(dom.wartungskostenWPSlider.value),
            usePV: pvIcon?.classList.contains('active'),
            pvAnteil: parseFloat(dom.pvAnteilSlider.value) / 100,
            pvStrompreis: parseFloat(dom.pvStrompreisInput.value),
            useSolarthermie: solarIcon?.classList.contains('active'),
            solarthermieFlaeche: parseFloat(dom.solarthermieFlaecheSlider.value) || 0,
            solarthermieTyp: dom.solarthermieTypeValue.value,
            useFans: fanIcon?.classList.contains('active'),
        };
        inputs.solarthermieErtrag = inputs.useSolarthermie ? inputs.solarthermieFlaeche * (config.solarYieldFactors[inputs.solarthermieTyp] || 0) : 0;
        let energieInputAltanlage_kWh = 0;
        if (inputs.isVerbrauch) {
            energieInputAltanlage_kWh = inputs.verbrauch * (config.energyFactors[inputs.aktuellesSystem] || 0);
        } else {
            energieInputAltanlage_kWh = inputs.flaeche * (config.klasseFactors[inputs.gebaeudeklasse] || 0);
        }
        if (inputs.aktuellesSystem === 'strom') inputs.wirkungsgradAlt = 1.0;
        let nutzwaermebedarf_kWh = energieInputAltanlage_kWh * inputs.wirkungsgradAlt;
        let kostenAltBrennstoff = 0;
        if (inputs.isVerbrauch) {
            kostenAltBrennstoff = inputs.verbrauch * inputs.aktuellerPreis;
        } else {
            const faktor = config.energyFactors[inputs.aktuellesSystem] || 1;
            kostenAltBrennstoff = (energieInputAltanlage_kWh / faktor) * inputs.aktuellerPreis;
        }
        const kostenAktuellGesamt = kostenAltBrennstoff + inputs.wartungAlt;
        const co2Altanlage = energieInputAltanlage_kWh * (config.co2FactorsKwhInput[inputs.aktuellesSystem] || 0);
        let wpBedarf_kWh = nutzwaermebedarf_kWh;
        if (inputs.useSolarthermie) {
            wpBedarf_kWh = Math.max(0, nutzwaermebedarf_kWh - inputs.solarthermieErtrag);
        }
        let effektiveVorlaufTemp = inputs.vorlaufTemp;
        if (inputs.useFans) {
            effektiveVorlaufTemp -= config.heizkoerperventilatorEffekt;
        }
        let basisSCOP = Math.max(2.0, 5 - 0.1 * (effektiveVorlaufTemp - 35));
        let jaz_final = basisSCOP;
        if (!inputs.isVerbrauch) {
            if (inputs.anteilFBH >= 75) jaz_final += 0.3;
            else if (inputs.anteilFBH <= 25) jaz_final -= 0.3;
        }
        jaz_final = Math.max(2.0, jaz_final);
        const stromverbrauchWP_kWh = wpBedarf_kWh > 0 && jaz_final > 0 ? wpBedarf_kWh / jaz_final : 0;
        let kostenWPVal = 0;
        if (inputs.usePV) {
            const pvStrom_kWh = stromverbrauchWP_kWh * inputs.pvAnteil;
            const netzStrom_kWh = stromverbrauchWP_kWh - pvStrom_kWh;
            kostenWPVal = (netzStrom_kWh * inputs.netzStrompreis) + (pvStrom_kWh * inputs.pvStrompreis);
        } else {
            kostenWPVal = stromverbrauchWP_kWh * inputs.netzStrompreis;
        }
        const kostenWPGesamt = kostenWPVal + inputs.wartungWP;
        const co2WP = stromverbrauchWP_kWh * config.stromCo2Faktor;
        const ersparnisVal = kostenAktuellGesamt - kostenWPGesamt;
        const co2Ersparnis = co2Altanlage - co2WP;
        const wpLeistung = nutzwaermebedarf_kWh > 0 ? (nutzwaermebedarf_kWh / 2000) : 0;
        const effektiveInvestition = Math.max(0, inputs.investition - inputs.foerderung);
        let amortisation = '–';
        if (ersparnisVal > 0 && effektiveInvestition > 0) {
            amortisation = (effektiveInvestition / ersparnisVal).toFixed(1);
        } else if (ersparnisVal <= 0 && effektiveInvestition > 0) {
            amortisation = "Keine Amortisation";
        } else if (effektiveInvestition <= 0) {
            amortisation = "Sofort";
        }
        dom.nutzwaermeBedarfElem.textContent = nutzwaermebedarf_kWh.toFixed(0);
        dom.kostenAktuellElem.textContent = kostenAktuellGesamt.toFixed(2);
        dom.co2AltanlageElem.textContent = co2Altanlage.toFixed(0);
        dom.wpLeistungElem.textContent = wpLeistung.toFixed(1);
        dom.jazEffektivElem.textContent = jaz_final.toFixed(1);
        dom.kostenWPElem.textContent = kostenWPGesamt.toFixed(2);
        dom.co2WPElem.textContent = co2WP.toFixed(0);
        dom.ersparnisElem.classList.toggle('negative', ersparnisVal < 0);
        dom.ersparnisElem.textContent = ersparnisVal.toFixed(2);
        dom.co2ErsparnisElem.textContent = co2Ersparnis.toFixed(0);
        dom.co2FussballfelderElem.textContent = (co2Ersparnis > 0 ? (co2Ersparnis / config.kgCo2ProFussballfeldWaldProJahr) : 0).toFixed(1);
        dom.amortisationElem.textContent = amortisation;
      }

      function exportResultsToPDF() { /* ... unverändert ... */ }

      // --- Initiale Einrichtung ---
      const sliders = [
          {el: dom.wirkungsgradAltSlider, val: dom.wirkungsgradAltValue, unit: "%"},
          {el: dom.flaecheSlider, val: dom.flaecheValue, unit: "m²"},
          {el: dom.anteilFussbodenheizungSlider, val: dom.anteilFussbodenheizungValue, unit: "%"},
          {el: dom.strompreisSlider, val: dom.strompreisValue, unit: "€/kWh", dec: 2},
          {el: dom.vorlauftemperaturSlider, val: dom.vorlauftemperaturValue, unit: "°C"},
          {el: dom.investitionSlider, val: dom.investitionValue, unit: "€"},
          {el: dom.foerderungenSlider, val: dom.foerderungenValue, unit: "€"},
          {el: dom.wartungskostenAltSlider, val: dom.wartungskostenAltValue, unit: "€"},
          {el: dom.wartungskostenWPSlider, val: dom.wartungskostenWPValue, unit: "€"},
          {el: dom.pvAnteilSlider, val: dom.pvAnteilValue, unit: "%"},
          {el: dom.solarthermieFlaecheSlider, val: dom.solarthermieFlaecheValue, unit: "m²"},
      ];
      sliders.forEach(s => setupSlider(s.el, s.val, s.unit, s.dec || 0));

      createIconOptions(gebaeudeklasseDefinitions, dom.gebaeudeklasseIconGroup, dom.gebaeudeklasseValueInput, handleGebaeudeklasseChange);
      createIconOptions(heizsystemDefinitions, dom.heizsystemIconGroup, dom.heizsystemValueInput, handleHeizsystemChange);
      createOptimizationIcons(optimizationDefinitions, dom.optimizationSelectionGroup);
      createIconOptions(solarthermieTypeDefinitions, dom.solarthermieTypeIconGroup, dom.solarthermieTypeValue, updateUIOnInputChange);
      
      form.addEventListener('input', updateUIOnInputChange);
      dom.radios.forEach(r => r.addEventListener('change', toggleCalculationMethod));
      dom.exportPdfButton.addEventListener('click', exportResultsToPDF);
      
      handleGebaeudeklasseChange(dom.gebaeudeklasseValueInput.value); 
      handleHeizsystemChange();
      toggleCalculationMethod();
      showPage(1);
    });
  </script>

  <!-- Skript für dynamische iFrame-Höhe -->
  <script>
    const sendHeight = () => {
      if (window.parent !== window) {
        const height = document.body.scrollHeight;
        window.parent.postMessage({ frameHeight: height }, '*');
      }
    };
    const resizeObserver = new ResizeObserver(() => sendHeight());
    resizeObserver.observe(document.body);
    window.addEventListener('load', sendHeight);
  </script>

</body>
</html>
